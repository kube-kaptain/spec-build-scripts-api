# SPDX-License-Identifier: CC-BY-SA-4.0
# Copyright (c) 2025 Kaptain contributors (Fred Cooke)
# Kaptain Build Scripts API Specification
# As-built from buildon-github-actions

$schema: https://github.com/kube-kaptain/spec-scripts-api-schema/releases/download/0.9/spec-scripts-api-schema-0.9.json
$id: https://github.com/kube-kaptain/${ProjectName}/releases/download/${Version}/${ProjectName}-${Version}.yaml

name: ${ProjectName}
version: "${Version}"
source: https://github.com/kube-kaptain/${ProjectName}
latest: https://raw.githubusercontent.com/kube-kaptain/${ProjectName}/main/${ProjectName}.yaml
tagged: https://raw.githubusercontent.com/kube-kaptain/${ProjectName}/${Version}/${ProjectName}.yaml
release: https://github.com/kube-kaptain/${ProjectName}/releases/download/${Version}/${ProjectName}-${Version}.yaml

description: |
  CI-agnostic build scripts for containerised application builds.
  Handles quality checks, versioning, Docker builds, and registry operations.

tool_requirements:
  # Core tools - validated first, used by version checks of later tools
  - name: GNU grep
    binary: grep
    min_version: "2.0"
    version_check: "grep --version | head -1"
    version_pattern: "([0-9]+\\.[0-9]+)"
    notes: Used for pattern matching in version checks

  - name: GNU sed
    binary: sed
    min_version: "4.0"
    version_check: "sed --version | head -1"
    version_pattern: "([0-9]+\\.[0-9]+)"
    notes: Used for text processing

  - name: Git
    binary: git
    min_version: "2.20"
    version_check: "git --version"
    version_pattern: "([0-9]+\\.[0-9]+)"
    homepage: https://git-scm.com
    download: https://git-scm.com/downloads
    notes: Required for version calculation and quality checks

  - name: Mike Farah YQ 4
    binary: yq
    min_version: "4.0"
    max_version: "5.0"
    version_check: "yq --version"
    version_pattern: "([0-9]+\\.[0-9]+)"
    homepage: https://github.com/mikefarah/yq
    download: https://github.com/mikefarah/yq/releases
    notes: Must be mikefarah/yq v4, not Python yq or v3

  - name: Docker CLI
    binary: docker
    min_version: "20.0"
    version_check: "docker --version"
    version_pattern: "([0-9]+\\.[0-9]+)"
    homepage: https://www.docker.com
    download: https://docs.docker.com/get-docker/
    notes: Required for image building and registry operations

  - name: awk
    binary: awk
    min_version: "2"
    max_version: "2"
    version_check: "echo '1.2.3' | awk -F. '{print $2}'"
    version_pattern: "([0-9]+)"
    notes: Functional check disguised as version check - outputs "2" if awk works. POSIX awk only - no gawk extensions.

  - name: Zip 3.0 by Info-Zip
    binary: zip
    min_version: "3.0"
    version_check: "zip --version | head -2 | tail -1"
    version_pattern: "([0-9]+\\.[0-9]+)"
    homepage: https://infozip.sourceforge.net
    notes: Required for manifest packaging

  - name: curl
    binary: curl
    min_version: "7.50"
    version_check: "curl --version | head -1"
    version_pattern: "curl ([0-9]+\\.[0-9]+)"
    homepage: https://curl.se
    notes: Required by cloud login plugins for API calls. Keep usage to basic features.

  - name: jq
    binary: jq
    min_version: "1.5"
    version_check: "jq --version"
    version_pattern: "jq-([0-9]+\\.[0-9]+)"
    homepage: https://jqlang.github.io/jq/
    notes: Required by spec-validate for JSON parsing. Keep usage to basic features.

entrypoints:
  basic-quality-checks:
    description: |
      Validate branch naming conventions, branch quality, merge candidate setup, and commit message quality.
      Designed to run as the first check in every build to fail fast on quality violations and poor practice.
    inputs:
      default-branch:
        type: string
        description: The default/release branch name
        env_var: DEFAULT_BRANCH
        default: main

      additional-release-branches:
        type: array
        description: Additional branches treated as release branches
        env_var: ADDITIONAL_RELEASE_BRANCHES
        default: []
        separator: ","

      block-slashes:
        type: boolean
        description: Reject branch names containing forward slashes
        env_var: BLOCK_SLASHES
        default: false
        added_in_version: "0.0"
        deprecated_in_version: "0.1"
        replaced_by: block-slash-containing-branches

      block-slash-containing-branches:
        type: boolean
        description: Reject branch names containing forward slashes
        env_var: BLOCK_SLASH_CONTAINING_BRANCHES
        default: false
        deprecated_alias: block-slashes
        added_in_version: "0.1"

      block-double-hyphen-containing-branches:
        type: boolean
        description: Reject branch names containing double hyphens (typo detection)
        env_var: BLOCK_DOUBLE_HYPHEN_CONTAINING_BRANCHES
        default: true

      require-conventional-branches:
        type: boolean
        description: Require conventional branch prefixes (feature/, fix/, etc.)
        env_var: REQUIRE_CONVENTIONAL_BRANCHES
        default: false

      require-conventional-commits:
        type: boolean
        description: Require conventional commit message format
        env_var: REQUIRE_CONVENTIONAL_COMMITS
        default: false

      block-conventional-commits:
        type: boolean
        description: Block conventional commit format (mutually exclusive with require)
        env_var: BLOCK_CONVENTIONAL_COMMITS
        default: false

      target-branch:
        type: string
        description: Target branch for rebase checks
        env_var: TARGET_BRANCH
        default: "${DEFAULT_BRANCH}"

      merge-candidate-branch:
        type: string
        description: Source branch being checked
        env_var: MERGE_CANDIDATE_BRANCH
        default: "(current branch)"

      merge-candidate-creator:
        type: string
        description: Username or ID of the merge candidate creator (for bot detection)
        env_var: MERGE_CANDIDATE_CREATOR
        default: ""

      log-error-prefix:
        type: string
        description: Prefix for error messages (CI integration)
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages (CI integration)
        env_var: LOG_ERROR_SUFFIX
        default: ""

    outputs: {}

    exit_codes:
      "0": All quality checks passed
      '1': Unexpected error from tooling
      "2": |
        Bad branch name. Checks:
        - Auto-generated pattern: always-on (branch names in the form creator-patch-N)
        - Slashes: default off (turn on with block-slash-containing-branches=true)
        - Double hyphens: default on (turn off with block-double-hyphen-containing-branches=false)
        - Conventional prefixes: default off (turn on with require-conventional-branches=true)
      "4": |
        Bad commit message. Checks:
        - Web UI auto-generated: always-on ("Update X", "Create X", and "Delete X" prefixes are bad even if hand written)
        - Require conventional format: default off (turn on with require-conventional-commits=true)
        - Block conventional format: default off (turn on with block-conventional-commits=true)
      "8": |
        Bad branch contents. Checks:
        - Merge commit detected: always-on (No matter how they got there, eg back-merge from main, this isn't okay)
        - Not rebased onto target: always-on (If not up to date with respect the target, we cannot guarantee correctness after merge)
      "16": |
        Bad merge candidate setup. Checks:
        - Invalid target branch: always-on (controlled by default-branch and additional-release-branches)
        - Target branch not found: always-on
      '32': Reserved
      '64': Reserved
      '128': Reserved

    exit_codes_combinable: true

    notes: |
      Exit codes other than 1 are bit flags and are combined before being returned.
      For example, exit code 6 means both bad branch name (2) and bad commit message (4).

  versions-and-naming:
    description: |
      Calculate version numbers and generate naming for Docker images.
      Supports multiple version calculation strategies via plugins.
    inputs:
      default-branch:
        type: string
        description: The default/release branch name
        env_var: DEFAULT_BRANCH
        default: main

      additional-release-branches:
        type: array
        description: Additional branches treated as release branches
        env_var: ADDITIONAL_RELEASE_BRANCHES
        default: []
        separator: ","

      max-version-parts:
        type: integer
        description: Maximum version depth (2, 3, or 4 parts)
        env_var: MAX_VERSION_PARTS
        default: 3
        min: 2
        max: 4

      tag-version-calculation-strategy:
        type: string
        description: Strategy plugin for version calculation
        env_var: TAG_VERSION_CALCULATION_STRATEGY
        default: git-auto-closest-highest
        allowed_values:
          - git-auto-closest-highest
          - file-pattern-match

      tag-version-pattern-type:
        type: string
        description: Pattern type for file-based version extraction
        env_var: TAG_VERSION_PATTERN_TYPE
        default: dockerfile-env-kubectl

      tag-version-prefix-parts:
        type: integer
        description: Number of version prefix parts to preserve
        env_var: TAG_VERSION_PREFIX_PARTS

      dockerfile-sub-path:
        type: string
        description: Path to Dockerfile directory
        env_var: DOCKERFILE_SUB_PATH
        default: ""

      tag-version-source-sub-path:
        type: string
        description: Subdirectory containing version source
        env_var: TAG_VERSION_SOURCE_SUB_PATH
        default: ""

      tag-version-source-file-name:
        type: string
        description: Filename containing version
        env_var: TAG_VERSION_SOURCE_FILE_NAME
        default: ""

      tag-version-source-custom-pattern:
        type: string
        description: Custom regex pattern for version extraction
        env_var: TAG_VERSION_SOURCE_CUSTOM_PATTERN
        default: ""

      build-mode:
        type: string
        description: Build mode that controls release eligibility, and publishing of artifacts (including a git tag)
        env_var: BUILD_MODE
        default: local
        allowed_values:
          - local
          - build_server
        notes: Defaults to 'local' (safe, no releases). CI pipelines must explicitly set 'build_server' to enable pushing the generated tag and publishing artifacts. Operators with bootstrap or recovery build requirements and write access to necessary repos must configure this deliberately.

      log-error-prefix:
        type: string
        description: Prefix for error messages
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages
        env_var: LOG_ERROR_SUFFIX
        default: ""

    outputs:
      version:
        type: string
        description: Full calculated version (e.g., 1.2.3)
        env_var: VERSION

      version-major:
        type: string
        description: Major version number
        env_var: VERSION_MAJOR

      version-minor:
        type: string
        description: Minor version number
        env_var: VERSION_MINOR

      version-patch:
        type: string
        description: Patch version number
        env_var: VERSION_PATCH

      version-2-part:
        type: string
        description: Version padded/truncated to 2 parts
        env_var: VERSION_2_PART

      version-3-part:
        type: string
        description: Version padded/truncated to 3 parts
        env_var: VERSION_3_PART

      version-4-part:
        type: string
        description: Version padded/truncated to 4 parts
        env_var: VERSION_4_PART

      docker-tag:
        type: string
        description: Docker tag (version for release, version-PRERELEASE otherwise)
        env_var: DOCKER_TAG

      docker-image-name:
        type: string
        description: Docker image name (prefix/project-name)
        env_var: DOCKER_IMAGE_NAME

      is-release:
        type: boolean
        description: Whether this is a release build
        env_var: IS_RELEASE

      project-name:
        type: string
        description: Repository/project name
        env_var: PROJECT_NAME

    exit_codes:
      "0": Success
      "1": Invalid input (bad BUILD_MODE, strategy not found)
      "42": Infrastructure failure (git operations)

  docker-build-dockerfile:
    description: |
      Build a Docker image from a Dockerfile.
      Handles token substitution, squashing, and label injection.
    inputs:
      docker-target-registry:
        type: string
        description: Target container registry hostname
        env_var: DOCKER_TARGET_REGISTRY
        required: true

      docker-target-base-path:
        type: string
        description: Path between registry and image name
        env_var: DOCKER_TARGET_BASE_PATH
        default: ""

      dockerfile-sub-path:
        type: string
        description: Path to Dockerfile directory
        env_var: DOCKERFILE_SUB_PATH
        default: src/docker

      output-sub-path:
        type: string
        description: Build output directory
        env_var: OUTPUT_SUB_PATH
        default: target

      squash:
        type: boolean
        description: Squash image layers
        env_var: SQUASH
        default: true

      no-cache:
        type: boolean
        description: Disable Docker layer caching
        env_var: NO_CACHE
        default: true

      substitution-token-style:
        type: string
        description: Token substitution syntax style
        env_var: SUBSTITUTION_TOKEN_STYLE
        default: shell
        allowed_values:
          - shell
          - mustache
          - helm
          - erb
          - github-actions
          - blade
          - stringtemplate
          - ognl
          - t4
          - swift

      token-name-style:
        type: string
        description: Case style for token names
        env_var: TOKEN_NAME_STYLE
        default: PascalCase
        allowed_values:
          - PascalCase
          - camelCase
          - lower_snake
          - UPPER_SNAKE
          - lower-kebab
          - UPPER-KEBAB
          - lower.dot
          - UPPER.DOT
          - ALL

      token-name-validation:
        type: string
        description: Token name validation mode
        env_var: TOKEN_NAME_VALIDATION
        default: MATCH

      allow-builtin-token-override:
        type: boolean
        description: Allow overriding built-in tokens
        env_var: ALLOW_BUILTIN_TOKEN_OVERRIDE
        default: false

      config-sub-path:
        type: string
        description: Configuration directory path
        env_var: CONFIG_SUB_PATH
        default: src/config

      config-value-trailing-newline:
        type: string
        description: Trailing newline handling for config values
        env_var: CONFIG_VALUE_TRAILING_NEWLINE
        default: strip-for-single-line

      docker-image-name:
        type: string
        description: Target image name (from versions-and-naming)
        env_var: DOCKER_IMAGE_NAME
        required: true

      docker-tag:
        type: string
        description: Target image tag (from versions-and-naming)
        env_var: DOCKER_TAG
        required: true

      version:
        type: string
        description: Version string (from versions-and-naming)
        env_var: VERSION
        required: true

      project-name:
        type: string
        description: Project name (from versions-and-naming)
        env_var: PROJECT_NAME
        required: true

      log-error-prefix:
        type: string
        description: Prefix for error messages
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages
        env_var: LOG_ERROR_SUFFIX
        default: ""

      log-warning-prefix:
        type: string
        description: Prefix for warning messages
        env_var: LOG_WARNING_PREFIX
        default: ""

      log-warning-suffix:
        type: string
        description: Suffix for warning messages
        env_var: LOG_WARNING_SUFFIX
        default: ""

    outputs:
      docker-target-image-full-uri:
        type: string
        description: Full image reference for push step
        env_var: DOCKER_TARGET_IMAGE_FULL_URI

      docker-substituted-sub-path:
        type: string
        description: Directory containing substituted files (for downstream use)
        env_var: DOCKER_SUBSTITUTED_SUB_PATH

    exit_codes:
      "0": Success
      "1": Validation failure (missing Dockerfile, wrong case, image exists, docker issues)
      "42": Infrastructure failure

  docker-build-retag:
    description: |
      Pull an upstream image and retag it for your registry.
      Used for repackaging third-party images.
    inputs:
      docker-source-registry:
        type: string
        description: Source container registry hostname
        env_var: DOCKER_SOURCE_REGISTRY
        required: true

      docker-source-base-path:
        type: string
        description: Source path between registry and image name
        env_var: DOCKER_SOURCE_BASE_PATH
        default: ""

      docker-source-image-name:
        type: string
        description: Source image name
        env_var: DOCKER_SOURCE_IMAGE_NAME
        required: true

      docker-source-tag:
        type: string
        description: Source image tag
        env_var: DOCKER_SOURCE_TAG
        required: true

      docker-target-registry:
        type: string
        description: Target container registry hostname
        env_var: DOCKER_TARGET_REGISTRY
        required: true

      docker-target-base-path:
        type: string
        description: Target path between registry and image name
        env_var: DOCKER_TARGET_BASE_PATH
        default: ""

      docker-image-name:
        type: string
        description: Target image name (from versions-and-naming)
        env_var: DOCKER_IMAGE_NAME
        required: true

      docker-tag:
        type: string
        description: Target image tag (from versions-and-naming)
        env_var: DOCKER_TAG
        required: true

      log-error-prefix:
        type: string
        description: Prefix for error messages
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages
        env_var: LOG_ERROR_SUFFIX
        default: ""

      log-warning-prefix:
        type: string
        description: Prefix for warning messages
        env_var: LOG_WARNING_PREFIX
        default: ""

      log-warning-suffix:
        type: string
        description: Suffix for warning messages
        env_var: LOG_WARNING_SUFFIX
        default: ""

    outputs:
      docker-source-image-full-uri:
        type: string
        description: Full source image reference
        env_var: DOCKER_SOURCE_IMAGE_FULL_URI

      docker-target-image-full-uri:
        type: string
        description: Full target image reference
        env_var: DOCKER_TARGET_IMAGE_FULL_URI

    exit_codes:
      "0": Success
      "1": Validation failure (registry format, image exists)
      "42": Infrastructure failure

  docker-push:
    description: |
      Push a Docker image to registry.
      Only pushes on release builds.
    inputs:
      docker-image-full-uri:
        type: string
        description: Full image reference to push
        env_var: DOCKER_IMAGE_FULL_URI
        required: true

      is-release:
        type: boolean
        description: Only push if true
        env_var: IS_RELEASE
        default: false

    outputs:
      image-pushed:
        type: boolean
        description: Whether image was pushed
        env_var: IMAGE_PUSHED

    exit_codes:
      "0": Success (pushed or skipped)

    notes: |
      Silently skips push when IS_RELEASE is false.
      Designed to be safe to call on all builds.

  docker-registry-logins:
    description: |
      Authenticate to one or more container registries.
      Supports multiple providers via plugin architecture.
    inputs:
      config:
        type: string
        description: YAML configuration with registry definitions
        env_var: CONFIG
        required: true

      secret-method:
        type: string
        description: Method for retrieving secrets
        env_var: SECRET_METHOD
        required: true
        allowed_values:
          - github
          - env

      secrets-json:
        type: string
        description: JSON object containing secrets
        env_var: SECRETS_JSON
        default: "{}"

      log-error-prefix:
        type: string
        description: Prefix for error messages
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages
        env_var: LOG_ERROR_SUFFIX
        default: ""

      log-group-start:
        type: string
        description: Group start marker (CI integration)
        env_var: LOG_GROUP_START
        default: ""

      log-group-end:
        type: string
        description: Group end marker (CI integration)
        env_var: LOG_GROUP_END
        default: ""

    outputs: {}

    exit_codes:
      "0": Success
      "1": Configuration failure (missing config, invalid method, missing secrets, unknown login type)

    notes: |
      Supported login types:
      - username-password: Basic authentication
      - github-token: GitHub token authentication
      - aws-ecr: AWS ECR with credentials
      - aws-ecr-github-actions-oidc: AWS ECR with OIDC
      - gcp-gar: Google Artifact Registry with service account
      - gcp-gar-github-actions-oidc: GAR with OIDC
      - azure-acr: Azure Container Registry with credentials
      - azure-acr-github-actions-oidc: ACR with OIDC

  kubernetes-manifests-package:
    description: |
      Package Kubernetes manifests into a zip with variable substitution.
      Prepares manifests for deployment by replacing tokens with actual values.
    inputs:
      manifests-sub-path:
        type: string
        description: Directory containing Kubernetes manifests (relative)
        env_var: MANIFESTS_SUB_PATH
        default: src/kubernetes

      project-name:
        type: string
        description: Project name for variable substitution
        env_var: PROJECT_NAME
        required: true

      version:
        type: string
        description: Version for variable substitution and naming
        env_var: VERSION
        required: true

      output-sub-path:
        type: string
        description: Build output directory (relative)
        env_var: OUTPUT_SUB_PATH
        default: target

      docker-tag:
        type: string
        description: Docker tag for variable substitution (optional)
        env_var: DOCKER_TAG
        default: ""

      docker-image-name:
        type: string
        description: Docker image name for variable substitution (optional)
        env_var: DOCKER_IMAGE_NAME
        default: ""

      docker-image-full-uri:
        type: string
        description: Full Docker image URI for variable substitution (optional)
        env_var: DOCKER_IMAGE_FULL_URI
        default: ""

      docker-target-registry:
        type: string
        description: Target registry for variable substitution (optional)
        env_var: TARGET_REGISTRY
        default: ""

      docker-target-base-path:
        type: string
        description: Target base path for variable substitution (optional)
        env_var: TARGET_BASE_PATH
        default: ""

      is-release:
        type: string
        description: Release flag for variable substitution (optional)
        env_var: IS_RELEASE
        default: ""

      substitution-token-style:
        type: string
        description: Token delimiter syntax for variables
        env_var: SUBSTITUTION_TOKEN_STYLE
        default: shell
        allowed_values:
          - shell
          - mustache
          - helm
          - erb
          - github-actions
          - blade
          - stringtemplate
          - ognl
          - t4
          - swift

      token-name-style:
        type: string
        description: Case style for token names in manifests
        env_var: TOKEN_NAME_STYLE
        default: PascalCase
        allowed_values:
          - PascalCase
          - camelCase
          - lower_snake
          - UPPER_SNAKE
          - lower-kebab
          - UPPER-KEBAB
          - lower.dot
          - UPPER.DOT
          - ALL

      token-name-validation:
        type: string
        description: How to validate user token names (MATCH = must match token-name-style, ALL = accept any valid name)
        env_var: TOKEN_NAME_VALIDATION
        default: MATCH

      allow-builtin-token-override:
        type: boolean
        description: Allow user tokens to override built-in tokens (for template/reusable projects)
        env_var: ALLOW_BUILTIN_TOKEN_OVERRIDE
        default: false

      config-sub-path:
        type: string
        description: Directory containing user-defined token files (relative)
        env_var: CONFIG_SUB_PATH
        default: src/config

      config-value-trailing-newline:
        type: string
        description: How to handle trailing newlines in config values
        env_var: CONFIG_VALUE_TRAILING_NEWLINE
        default: strip-for-single-line
        allowed_values:
          - strip-for-single-line
          - preserve-all
          - always-strip-one-newline

      log-error-prefix:
        type: string
        description: Prefix for error messages
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages
        env_var: LOG_ERROR_SUFFIX
        default: ""

    outputs:
      manifests-zip-sub-path:
        type: string
        description: Directory containing the zip file (relative)
        env_var: MANIFESTS_ZIP_SUB_PATH

      manifests-zip-file-name:
        type: string
        description: Filename of the zip
        env_var: MANIFESTS_ZIP_FILE_NAME

    exit_codes:
      "0": Success
      "1": Validation or packaging failure

  kubernetes-manifests-repo-provider-package:
    description: |
      Selector script that dispatches to repo provider package plugins.
      Packages manifests for the repo provider (e.g., builds docker image) but does NOT publish.
    inputs:
      manifests-repo-provider-type:
        type: string
        description: Type of repo provider to use
        env_var: MANIFESTS_REPO_PROVIDER_TYPE
        default: docker

      log-error-prefix:
        type: string
        description: Prefix for error messages
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages
        env_var: LOG_ERROR_SUFFIX
        default: ""

    outputs: {}

    exit_codes:
      "0": Success
      "1": Unknown repo provider type (package script does not exist)
      "2": Repo provider type package script is not executable

    notes: |
      Router script - all other inputs are passed through to the selected plugin.
      Available providers discovered from plugins/kubernetes-manifests-repo-providers/

  kubernetes-manifests-repo-provider-publish:
    description: |
      Selector script that dispatches to repo provider publish plugins.
      Publishes packaged manifests via the repo provider (e.g., pushes docker image).
    inputs:
      manifests-repo-provider-type:
        type: string
        description: Type of repo provider to use
        env_var: MANIFESTS_REPO_PROVIDER_TYPE
        default: docker

      log-error-prefix:
        type: string
        description: Prefix for error messages
        env_var: LOG_ERROR_PREFIX
        default: ""

      log-error-suffix:
        type: string
        description: Suffix for error messages
        env_var: LOG_ERROR_SUFFIX
        default: ""

    outputs:
      manifests-uri:
        type: string
        description: Reference to published manifests (format depends on repo provider)
        env_var: MANIFESTS_URI

      manifests-published:
        type: boolean
        description: Whether manifests were published
        env_var: MANIFESTS_PUBLISHED

    exit_codes:
      "0": Success
      "1": Unknown repo provider type (publish script does not exist)
      "2": Repo provider type publish script is not executable

    notes: |
      Router script - all other inputs are passed through to the selected plugin.
      Available providers discovered from plugins/kubernetes-manifests-repo-providers/

  spec-package-prepare:
    description: Prepare spec files for packaging into OCI image
    inputs:
      project-name:
        type: string
        description: Project name (used to find ${PROJECT_NAME}.yaml)
        env_var: PROJECT_NAME
        required: true
      version:
        type: string
        description: Version string for output filenames
        env_var: VERSION
        required: true
      output-sub-path:
        type: string
        description: Base directory for output files
        env_var: OUTPUT_SUB_PATH
        required: true
      spec-packaging-base-image:
        type: string
        description: Base image for generated Dockerfile
        env_var: SPEC_PACKAGING_BASE_IMAGE
        default: scratch
    outputs:
      spec-sub-path:
        type: string
        description: Directory containing spec files (relative)
        env_var: SPEC_SUB_PATH
      spec-yaml:
        type: string
        description: Filename of versioned YAML spec
        env_var: SPEC_YAML
      spec-json:
        type: string
        description: Filename of versioned JSON spec
        env_var: SPEC_JSON
      dockerfile-sub-path:
        type: string
        description: Directory containing generated Dockerfile
        env_var: DOCKERFILE_SUB_PATH
    exit_codes:
      "0": Success
      "1": Spec file not found
    notes: |
      Copies spec YAML, converts to JSON, generates Dockerfile.
      Token substitution handled by docker build step.

  spec-validate:
    description: Validate spec file against its JSON schema
    inputs:
      spec-type:
        type: string
        description: Type of spec being validated
        env_var: SPEC_TYPE
        required: true
        allowed_values:
          - schema
          - api
      spec-sub-path:
        type: string
        description: Directory containing spec files (relative)
        env_var: SPEC_SUB_PATH
        required: true
      spec-json:
        type: string
        description: Filename of spec JSON file
        env_var: SPEC_JSON
        required: true
      spec-validation-type:
        type: string
        description: Validation method to use
        env_var: SPEC_VALIDATION_TYPE
        default: basic
        allowed_values:
          - basic
          - python3-jsonschema
    outputs: {}
    exit_codes:
      "0": Validation passed
      "1": Validation failed (missing file, invalid type, schema mismatch)
    notes: |
      Run after docker build has performed token substitution.
      For api specs, reads $schema from the spec file.
      For schema specs, validates against JSON Schema draft-07.

internals:
  docker-build-shared:
    description: Shared functions for docker build scripts
    called_by:
      - docker-build-dockerfile
      - docker-build-retag
    inputs:
      docker-target-registry:
        type: string
        description: Target registry hostname
        env_var: DOCKER_TARGET_REGISTRY
        required: true

      docker-target-base-path:
        type: string
        description: Target base path
        env_var: DOCKER_TARGET_BASE_PATH
        default: ""

      docker-image-name:
        type: string
        description: Image name
        env_var: DOCKER_IMAGE_NAME
        required: true

      docker-tag:
        type: string
        description: Image tag
        env_var: DOCKER_TAG
        required: true

    outputs:
      docker-target-image-full-uri:
        type: string
        description: Assembled full image URI
        env_var: DOCKER_TARGET_IMAGE_FULL_URI

    notes: |
      Sourced by docker build scripts, not executed directly.
      Provides: confirm_target_image_doesnt_exist(), output_var()

  version-sort:
    description: Sort version strings semantically
    called_by:
      - versions-and-naming
    inputs:
      versions:
        type: array
        description: Versions to sort (one per line on stdin)
        env_var: VERSIONS

    outputs:
      sorted:
        type: string
        description: Sorted versions, one per line
        stdout: true

  prepare-substitution-tokens:
    description: Prepare token values for substitution
    called_by:
      - docker-build-dockerfile
      - kubernetes-manifests-package

  substitute-tokens-from-dir:
    description: Perform token substitution on files
    called_by:
      - docker-build-dockerfile
      - kubernetes-manifests-package

  format-project-title:
    description: Format lower-kebab style project name into display title
    inputs:
      project-name:
        type: string
        description: Project name in lower-kebab naming style (e.g., kaptain-build-scripts)
        positional: true
        required: true
    outputs:
      title:
        type: string
        description: Formatted title (e.g., Kaptain Build Scripts)
        stdout: true
    notes: |
      Handles special words: API, GitHub, AWS, GCP, CLI, JSON, YAML, etc.
      Used for display purposes. For example in platform specific GitHub release titles.

deprecations:
  BLOCK_SLASHES:
    replaced_by: BLOCK_SLASH_CONTAINING_BRANCHES
    added_in_version: "0.0"
    deprecated_in_version: "0.1"
    notes: Renamed for clarity. Both names currently work.
